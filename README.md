# 태양광 인버터 시뮬레이터 v2.0

태양광 발전소 인버터 시뮬레이터 - Modbus RTU/RS-485 통신 지원

## 📋 목차

- [개요](#개요)
- [주요 기능](#주요-기능)
- [시스템 구성](#시스템-구성)
- [설치 및 실행](#설치-및-실행)
- [사용 방법](#사용-방법)
- [Modbus RTU 통신](#modbus-rtu-통신)
- [파일 구조](#파일-구조)
- [기술 스택](#기술-스택)

## 개요

이 프로젝트는 태양광 발전소의 인버터를 시뮬레이션하는 시스템입니다. 실제 인버터와 동일하게 Modbus RTU 프로토콜을 통해 RTU(Remote Terminal Unit)와 통신할 수 있습니다.

### 시스템 사양
- **발전소 용량**: 1 MVA
- **인버터 수**: 4대
- **인버터 용량**: 각 250 kVA
- **통신 방식**: Modbus RTU over RS-485
- **슬레이브 ID**: 1, 2, 3, 4 (각 인버터별)

## 주요 기능

### 1. 태양광 발전 시뮬레이션
- ✅ PV 발전기 On/Off 제어
- ✅ MPPT 제어 모드
- ✅ P 제어 모드 (출력 비율 설정)
- ✅ 일사량 및 온도 설정
- ✅ ±1% 랜덤 진동 (일사량, 온도)

### 2. 인버터 시뮬레이션
- ✅ DC → AC 변환
- ✅ 효율 계산 (97%)
- ✅ 정격 용량 제한
- ✅ 실시간 모니터링 (전압, 전류, 전력, 역률 등)

### 3. Modbus RTU 통신
- ✅ 표준 Modbus RTU 프로토콜 지원
- ✅ RS-485 멀티드롭 버스 구조
- ✅ 여러 슬레이브(인버터) 동시 지원
- ✅ Sungrow 인버터 레지스터 매핑 적용
- ✅ 자동 서버 시작 (인버터 ON 시)

### 4. 웹 기반 모니터링 및 제어
- ✅ 실시간 발전량 모니터링
- ✅ 시계열 그래프 (Chart.js)
- ✅ 시간별 누적 발전량 표시
- ✅ 인버터별 상태 모니터링
- ✅ 원격 제어 (On/Off, 제어 모드, 출력 비율)
- ✅ RS-485 통신 상태 표시
- ✅ 통신 로그 실시간 표시

## 시스템 구성

```
[RTU (마스터)]
    ↓ Modbus RTU 요청
    ↓ RS-485 버스
[인버터 시뮬레이터 (슬레이브)]
    ├─ 슬레이브 ID 1 (인버터 1)
    ├─ 슬레이브 ID 2 (인버터 2)
    ├─ 슬레이브 ID 3 (인버터 3)
    └─ 슬레이브 ID 4 (인버터 4)
    ↓ Modbus RTU 응답
    ↑
```

## 설치 및 실행

### 1. 필수 요구사항
- Python 3.7 이상
- RS-485 어댑터 (실제 RTU 통신 시)

### 2. 의존성 설치

```bash
pip install -r requirements.txt
```

주요 패키지:
- `Flask>=2.3.0` - 웹 서버
- `flask-cors>=4.0.0` - CORS 지원
- `pymodbus>=3.5.0` - Modbus RTU 통신
- `pyserial>=3.5` - 시리얼 포트 통신

### 3. 실행

#### 웹 서버 실행 (권장)
```bash
python web_server.py
```

웹 브라우저에서 `http://localhost:5000` 접속

#### 콘솔 모드 실행
```bash
python main.py
```

## 사용 방법

### 웹 인터페이스

1. **시뮬레이션 시작**
   - 웹 서버 실행 시 자동으로 시작
   - 또는 "시뮬레이션 시작" 버튼 클릭

2. **인버터 제어**
   - 개별 인버터 On/Off
   - 모든 인버터 일괄 제어
   - 제어 모드 변경 (MPPT / P 제어)
   - P 제어 출력 비율 설정

3. **환경 설정**
   - 일사량 설정 (W/m²)
   - 온도 설정 (°C)

4. **모니터링**
   - 전체 발전량
   - 인버터별 상세 정보
   - 시계열 그래프
   - 시간별 누적 발전량

5. **RS-485 통신 상태**
   - 포트 연결 상태
   - 슬레이브별 통계
   - 실시간 통신 로그

### Modbus RTU 통신 설정

`config.py`에서 통신 설정을 변경할 수 있습니다:

```python
SYSTEM_CONFIG = {
    "modbus": {
        "slave_id": 1,  # 첫 번째 인버터의 슬레이브 ID
        "port": "COM1",  # Windows: COM1, Linux: /dev/ttyUSB0
        "baudrate": 9600,
        "parity": "N",
        "stopbits": 1,
        "bytesize": 8
    }
}
```

## Modbus RTU 통신

### 지원 기능 코드
- `0x03`: Read Holding Registers
- `0x04`: Read Input Registers
- `0x06`: Write Single Register
- `0x10`: Write Multiple Registers

### 주요 레지스터 주소 (Sungrow 인버터 기준)

#### 제어 레지스터 (Holding Register)
- **5006**: 시작/정지 (0xCF: Start, 0xCE: Stop)
- **5007**: 제어 모드 스위치 (0xAA: P제어, 0x55: MPPT)
- **5008**: P 제어 출력 비율 설정 (0-1000, 스케일 0.10%)

#### 모니터링 레지스터 (Input Register)
- **5001**: 정격 유효 전력 (kW) * 10
- **5003**: 일일 발전량 (kWh) * 10
- **5004-5005**: 총 발전량 (kWh, U32)
- **5011**: MPPT 1 전압 (V) * 10
- **5012**: MPPT 1 전류 (A) * 10
- **5017-5018**: 총 DC 전력 (W, U32)
- **5019**: AC 선간 전압 A-B (V) * 10
- **5022**: A상 전류 (A) * 10
- **5031-5032**: 총 유효 전력 (W, S32)
- **5033-5034**: 총 무효 전력 (Var, S32)
- **5035**: 역률 * 1000
- **5036**: 계통 주파수 (Hz) * 10
- **5038**: 운전 상태 1

### 통신 흐름

1. **RTU 요청**
   ```
   RTU → [슬레이브 ID 1, Function Code 0x04, 주소 5004, 수량 2]
   ```

2. **인버터 시뮬레이터 응답**
   ```
   인버터 시뮬레이터 → [슬레이브 ID 1, Function Code 0x04, 데이터: 총 발전량]
   ```

### 자동 서버 시작

- 시뮬레이터 실행 시 자동으로 Modbus RTU 서버 시작
- 인버터 ON 시 서버 자동 시작
- 실제 인버터와 동일한 동작

## 파일 구조

```
inverter_sim_v2/
├── README.md                 # 프로젝트 문서
├── requirements.txt          # Python 의존성
├── config.py                 # 시스템 설정 및 Modbus 레지스터 매핑
├── main.py                   # 콘솔 모드 메인 프로그램
├── web_server.py             # Flask 웹 서버
│
├── solar_pv_generator.py     # 태양광 PV 발전기 모듈
├── inverter.py               # 인버터 모듈
├── power_plant.py            # 발전소 통합 제어 모듈
│
├── modbus_rtu.py             # Modbus RTU 기초 구조 (레거시)
├── modbus_rtu_server.py      # Modbus RTU 서버 구현
├── modbus_rtu_manager.py     # Modbus RTU 서버 관리자
│
├── test_simulator.py         # 단위 테스트
│
├── templates/
│   └── index.html            # 웹 인터페이스 HTML
└── static/
    ├── css/
    │   └── style.css         # 스타일시트
    └── js/
        └── app.js            # 프론트엔드 JavaScript
```

## 기술 스택

### Backend
- **Python 3.7+**
- **Flask** - 웹 프레임워크
- **pymodbus** - Modbus RTU 프로토콜
- **pyserial** - 시리얼 포트 통신

### Frontend
- **HTML5 / CSS3**
- **JavaScript (ES6+)**
- **Chart.js** - 시계열 그래프

### 통신 프로토콜
- **Modbus RTU** - 산업용 통신 프로토콜
- **RS-485** - 물리적 통신 매체

## 주요 특징

### 1. 실제 인버터와 동일한 동작
- 인버터 ON 시 Modbus 서버 자동 시작
- 표준 Modbus RTU 프로토콜 준수
- Sungrow 인버터 레지스터 매핑 적용

### 2. 실시간 모니터링
- 웹 기반 실시간 대시보드
- 시계열 그래프
- 시간별 누적 발전량

### 3. 통신 상태 모니터링
- RS-485 연결 상태 확인
- 통신 로그 실시간 표시
- 슬레이브별 통계
- 연결 실패 시 알람 표시

### 4. 환경 시뮬레이션
- 일사량 및 온도 설정
- ±1% 랜덤 진동 (실제 환경 모사)

## 문제 해결

### Modbus 서버가 시작되지 않을 때
1. 시리얼 포트가 시스템에 존재하는지 확인
2. 포트가 다른 프로그램에서 사용 중인지 확인
3. `config.py`에서 포트 설정 확인

### 통신이 안 될 때
1. RS-485 어댑터 연결 확인
2. 통신 속도, 패리티 등 설정 확인
3. 슬레이브 ID 확인
4. 웹 인터페이스의 통신 로그 확인

## 개발 이력

### v2.0 (현재)
- ✅ Modbus RTU/RS-485 통신 구현
- ✅ 웹 기반 모니터링 및 제어
- ✅ 시계열 그래프 및 시간별 누적 발전량
- ✅ 통신 상태 모니터링
- ✅ 자동 서버 시작 기능
- ✅ Sungrow 인버터 레지스터 매핑 적용

### v1.0
- 기본 태양광 발전 시뮬레이션
- 인버터 모듈
- 발전소 통합 제어

## 라이선스

이 프로젝트는 교육 및 연구 목적으로 개발되었습니다.

## 참고 자료

- Modbus RTU 프로토콜 사양
- Sungrow 인버터 Modbus 레지스터 매핑 (PDF 참조)
- pymodbus 공식 문서: https://pymodbus.readthedocs.io/

---

**작성일**: 2025년 11월
**버전**: 2.0

